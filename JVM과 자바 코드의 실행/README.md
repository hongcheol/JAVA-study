# contents
- JVM이란 무엇인가
- JVM 구성 요소
- 바이트코드란 무엇인가
- JIT 컴파일러의 동작방식
- 컴파일 하는 방법
- 실행하는 방법
- JDK와 JRE의 차이

전체적인 내용에 앞서 자바의 소스코드가 실행되기까지의 과정에대한 그림을 먼저 소개하겠습니다.

![Java0](https://user-images.githubusercontent.com/16794320/129466965-bb19c8f9-a50c-4063-b9c1-aa636d71f445.png)

자바 컴파일러는 코드를 작성한 것의 의미를 분석하는 역할을 하고

JVM은 분석된 코드를 합쳐서 환경에 맞는 코드를 생성합니다.

# JVM

JVM은 'Java Virtual Machine'을 줄인 것으로 자바를 실행하기위한 가상 머신입니다. 

![JVM](https://user-images.githubusercontent.com/16794320/129466980-35ec27e8-43a0-4783-9ae0-2cf657efafa3.png)


## JVM 구성 요소

![JVM-Run-time-Data-Areas](https://javapapers.com/wp-content/uploads/2013/11/JVM-Run-time-Data-Areas.png)

[출처]https://javapapers.com/core-java/java-jvm-run-time-data-areas/#Java_Virtual_Machine_Stacks

JVM은 Method Area, Heap, Java stacks, PC registers, native method stacks로 구성되어있습니다. 이 영역은 JVM이 Java Bytecode를 실행하기위해 사용하는 메모리 공간입니다.

이는 다시 Thread별로 관리되는 영역과 모든 Thread가 공유하는 영역으로 나눌 수 있습니다.

### Per-Thread

스레드별로 관리되는 영역으로 생성된 모든 단일 스레드에대해서 unique하게 할당된 경우입니다. 이 데이터 영역은 Thread 가 시작될 때 초기화되고, Thread가 완료되면 소멸됩니다.

#### 1. PC Register

일반적으로 PC(Program Counter) register는 어떠한 상황에서도 현재 실행중인 instruction를 추적하는 역할을 합니다. 이는 멀티스레딩 환경을 제공하는 JVM에서도 같은 역할을 합니다. PC Register는 Thread가 생성될 때마다 생성되고, 그 Thread 안에서 실행되는 현재의 명령문에대한 포인터를 유지합니다. 하지만 메서드가 native하다면 PC register의 값은 정의가 되지않습니다.

#### 2. JVM Stacks

JVM stacks는 JVM 프레임을 저장하는데 사용됩니다. JVM은 스택에대한 어떠한 직접적인 조작을 하지않으며 프레임을 저장하는 장치일 뿐입니다. 스택의 사이즈는 가변적이거나 고정적입니다. 가변 사이즈는 필요에따라서 동적으로 확장을 할 수 있습니다. Java JVM 프레임들은 메서드가 호출되면 생성되는데, 이때 동적링크를 실행합니다. JVM 스택들은 각각의 Thread에 의해 생성되고 관리됩니다. 

JVM Stacks을 사용할 때는 다음의 에러를 주의해야합니다.

> StackOverflowError - 스택의 사이즈가 고정된 경우에 발생하는 에러로 프로그램 실행중에 스텍의 메모리 사이즈가 부족할 때 발생합니다.  
>
> OutOfMemoryError - 스택의 사이즈가 동적인 경우에 메모리가 더 필요해 확장할 때, 더 이상 할당할 수 있는 메모리가 없을 때 발생합니다.

#### 3. Native Method Stacks

JVM은 JIT 컴파일러를 사용해 native method를 가질 수 있습니다. native method는 Thread 별로 생성됩니다. 만약에 native method를 사용하려는데 JVM에 의해서 로드될 수 없다면, 해당 Thread에는 native method stack이 없다는 것을 의미합니다. 네이티브 메서드 스택의 메모리 사이즈는 일반적으로 JVM 스택과 비슷하게 관리됩니다. 

### Common Area

모든 Thread가 공유하는 영역입니다. JVM이 시작되면 초기화가 됐다가 종료되면 소멸됩니다.

#### 1. Heap

클래스와 배열 객체를 저장하는 영역입니다. heap 영역은 JVM이 시작될 때 생성되며 메모리의 회수는 가비지컬렉터에의해서 자동적으로 수행됩니다. 런타임에 heap 영역의 메모리가 충분하지않으면 OutOfMemoryError를 던집니다.

#### 2. Method Area

heap 영역 내부에 존재하는 영역입니다. 메서드 영역은 클래스 구조와 필드 영역을 가집니다. 이 영역에는 클래스의 구조와 static field만 존재합니다. 더 세부적으로 보면 메서드 데이터, 데서드와 생성자 코드, 런타임 상수 풀을 가지고있습니다.

#### 3. Run-time constant Pool

메서드 영역 안에 존재하는 영역으로 클래스나 인터페이스가 생성될 때 JVM에 의해서 생성됩니다. constant pool table이라는 테이블을 이용해서 상수를 관리합니다.

## JVM 장단점

자바로 작성된 어플리케이션은 모두 JVM에서만 실행되기 때문에, 자바 어플리케이션을 실행하려면 반드시 JVM이 필요합니다. Java 어플리케이션은 JVM을 한 번 더 거치고, 하드웨어에 맞게 컴파일 된 상태가 아닌 실행 시에 해석되기 때문에 코드의 실행속도가 느립니다. 

하지만 Java의 어플리케이션과 OS 사이에 JVM이 있음으로써 OS에 독립적인 코드를 작성할 수 있다는 장점이 있습니다. 

또한, 실행속도가 느리다는 단점을 바이트코드를 기계어로 변환해주는 JIT 컴파일러를 통해서 어느정도는 보완하고있습니다.



그렇다면 바이트코드는 뭐고 JIT 컴파일러는 뭘까요?

# 바이트코드

바이트 코드는 기계어는 아니지만 가상머신이 쉽게 기계어로 변환할 수 있는 코드입니다. 바이너리코드는 링커를 통해 여러 코드와 데이터를 모아 실행가능한 파일로 만들어서 컴퓨터가 이해할 수 있는 기계어로 번역되는 정적 컴파일 방식을 사용한다면, 바이트코드는 별도의 인터프리터라는 보조도구의 도움을 받는 JIT 컴파일 방식을 사용해 기계어로 번역합니다.

# JIT 컴파일러

## JIT 컴파일러란?

JIT(just-in-time)컴파일러는 프로그램을 실제로 실행하는 시점에 기계어로 번역하는 컴파일 기법을 적용한 컴파일러입니다. 

## JIT 컴파일러의 동작방식

컴파일 타입에 생성된 바이트코드를 런타임에 네이티브 코드로 변경합니다. 이렇게 변경된 네이티브 코드로 만들어진 메서드는 더 이상의 인터프리팅 과정없이 바로 실행할 수 있습니다. 생성된 네이티브 코드는 캐시에 보관되어 필요할 때 바로 꺼내쓸 수 있기 때문에 속도적인 측면에서 빠릅니다. 하지만 캐시의 용량이 제한되어있기 때문에, JIT컴파일러를 사용하는 JVM은 내부적으로 기준을 정하고 얼마나 자주 호출되고 실행되는지를 체크해서 기준을 넘는 메서드만 JIT 컴파일러를 통해 컴파일해 네이티브 코드를 생성합니다.

# 컴파일 및 실행 방법

자바 소스를 컴파일 및 실행하기 위해서는 다음과 같은 프로그램이 필요합니다.

## javac.exe

자바 컴파일러로 자바 소스코드를 바이트 코드로 컴파일합니다.

컴파일방법

``` shell
$ javac 소스파일명.java
```

성공적으로 컴파일을 마치면 해당 경로에 소스파일명.class가 생성됩니다.

## java.exe

자바 인터프리터로 컴파일러가 생성한 바이트 코드를 해석하고 실행합니다.

실행방법

```shell
$ java 소스파일명
```

실행할 때 확장자명 없이 소스파일명을 사용한다는 점만 주의하면 됩니다.

### 내부적인 진행 순서

1. 프로그램의 실행에 필요한 클래스(.class파일)을 로드합니다.
2. 클래스 파일의 파일 형식을 검사하고 악성코드인지 체크를 합니다.
3. 지정된 클래스에서 main(String[] args)를 호출합니다. 

## Javap.exe

역어셈블러로 컴파일된 클래스 파일을 원래의 소스로 변환해줍니다.

역어셈블방법

```shell
$ javap 소스파일명 > 소스파일명.java
```

# JDK와 JRE의 차이

## JDK 

자바개발도구(Java Development Kit) 로 JRE와 개발에 필요한 실행파일(javac.exe 등을 포함합니다.)

## JRE

자바실행환경(Java Runtime Environment) 로 자바로 작성된 어플리케이션이 실행되기 위한 최소 환경을 의미합니다. 

JRE는 JVM과 클래스 라이브러리인 Java API를 포함하고 있습니다. 

